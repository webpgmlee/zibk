<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="inbound">

	<!-- 고객코드 조회 -->
	<select id="selectCustCode" resultType="CodeDomain">
		SELECT MCODE, CODE_NAME FROM TH_CODE WHERE LCODE = '006' AND MCODE != '00'
			ORDER BY SORT_IDX ASC
	</select>

	<!-- 특이성향 여부조회(고객) -->
	<select id="selectSpclAppvYn" resultType="java.lang.String" parameterType="java.lang.String">
		SELECT SPCL_APPV_YN FROM TH_SPECIAL_CUST WHERE UNTY_CSNO = #{untyCsno}
	</select>

	<!-- 특이성향 여부조회(미고객) -->
	<select id="selectSpclAppvYn2" resultType="java.lang.String" parameterType="java.lang.String">
		SELECT SPCL_APPV_YN FROM TH_SPECIAL_CUST WHERE TELL_NUM = #{tlno}
	</select>

	<!-- 고객조회 검색조건(고객팝업) -->
	<select id="selectCsSearch" resultType="CustomerDomain" parameterType="CustomerDomain">
		SELECT
			    DISTINCT A.UNTY_CSNO,
                A.CS_KRN_NM,
			    A.CS_DSCD,
                B.TLNO,
                A.CS_SRCH_NO
			FROM IF_CM_UNTYCS_M A, IF_CM_CNPL_M B
                WHERE A.UNTY_CSNO = B.UNTY_CSNO
                <if test=" tlno != null and tlno !='' ">
                AND B.TLNO=#{tlno}
                </if>
                <if test=" csKrnNm != null and csKrnNm !='' ">
                AND A.CS_KRN_NM like '%' || #{csKrnNm} || '%'
                </if>
                <if test=" csDscd != null and csDscd !='' ">
                AND A.CS_DSCD like '%' || #{csDscd} || '%'
                </if>
                AND NVL(B.UNTY_CNTR_NO,'N') != 'N'
                AND NVL(A.CS_DSCD,'N') != 'N'
	</select>

	<!-- 고객번호조회 -->
	<select id="selectUntyCsno" parameterType="CustomerDomain" resultType="CustomerDomain">
		SELECT
			DISTINCT(A.UNTY_CSNO),
			B.CS_DSCD,
			#{tlno} AS TLNO,
			B.CS_SRCH_NO
		FROM
        	IF_CM_CNPL_M A JOIN IF_CM_UNTYCS_M B
        	ON A.UNTY_CSNO = B.UNTY_CSNO
        	WHERE A.TLNO = #{tlno}
        	AND NVL(A.UNTY_CNTR_NO,'N') != 'N'
        	AND NVL(B.CS_DSCD,'N') != 'N'
	</select>

	<!-- 고객번호로 고객/계약 조회(고객정보1건일경우) -->
	<select id="selectUntyCs" parameterType="CustomerDomain" resultType="CustomerDomain">
		SELECT
			A.UNTY_CSNO,
			A.CS_SRCH_NO,
			A.CS_DSCD,
			A.CS_KRN_NM,
			A.RL_CS_KRN_NM,
			B.DDCT_BIZ_DSCD,
			B.UNTY_CNTR_NO,
			B.CNTR_NO,
			B.BZPL_UNTY_CSNO,
			B.DLGT_UNTY_CSNO,
			B.BZEN_CHRPN_NM,
			B.SMS_YN,
			B.ABND_YN,
			(SELECT BADR || ' ' || DADR FROM IF_CM_ADR_M
		    	WHERE UNTY_CNTR_NO = B.UNTY_CNTR_NO
		    	AND UNTY_CSNO = A.UNTY_CSNO
		    	AND CS_ADR_POST_TRSPL_DSCD = B.POST_TRSPL_DSCD) AS ADDR,
			 #{tlno} AS TLNO
		FROM
			IF_CM_UNTYCS_M A FULL OUTER JOIN IF_CA_UNTYCNTR_M B
			ON A.UNTY_CSNO =
			<if test=" csDscd == '01' or csDscd == '07' ">
			B.DLGT_UNTY_CSNO
			</if>
			<if test=" csDscd == '02' or csDscd == '03' ">
			B.BZPL_UNTY_CSNO
			</if>
			WHERE A.UNTY_CSNO = #{untyCsno}
			ORDER BY B.CNTR_BGN_DT DESC
	</select>

	<!-- 고객조회(전화번호조건, 고객조회팝업) -->
	<select id="selectCustomer" resultType="CustomerDomain" parameterType="CustomerDomain">
            SELECT
			    DISTINCT A.UNTY_CSNO,
                A.CS_KRN_NM,
			    A.CS_DSCD,
                #{tlno} AS TLNO,
                A.CS_SRCH_NO
			FROM IF_CM_UNTYCS_M A, IF_CM_CNPL_M B
                WHERE A.UNTY_CSNO = B.UNTY_CSNO
                AND B.TLNO=#{tlno}
                AND NVL(B.UNTY_CNTR_NO,'N') != 'N'
                AND NVL(A.CS_DSCD,'N') != 'N'
	</select>

	<!-- 고객조회(고객번호, 고객정보는 있는데 계약이 없는경우) -->
	<select id="selectCustomer2" resultType="CustomerDomain" parameterType="CustomerDomain">
			SELECT
			    CS_KRN_NM,
			    CS_DSCD,
                #{tlno} AS TLNO,
                UNTY_CSNO,
                CS_SRCH_NO
			FROM IF_CM_UNTYCS_M
		        WHERE UNTY_CSNO = #{untyCsno}
	</select>

	<!-- 계약조회(고객번호) -->
	<select id="selectContract" resultType="UntyCntrDomain" parameterType="CustomerDomain">
		SELECT
			UNTY_CNTR_NO,
			CNTR_NO,
			DDCT_BIZ_DSCD,
			CNTR_BGN_DT,
			ABND_YN,
			DLGT_UNTY_CSNO,
			BZPL_UNTY_CSNO,
			#{untyCsno} AS UNTY_CSNO
		FROM IF_CA_UNTYCNTR_M
			WHERE
		<choose>
			<when test=" csDscd == '01' or csDscd == '07' ">
				DLGT_UNTY_CSNO = #{untyCsno}
			</when>
			<when test=" csDscd == '02' or csDscd == '03' ">
				BZPL_UNTY_CSNO = #{untyCsno}
			</when>
			<otherwise>
				DLGT_UNTY_CSNO = #{untyCsno}
			</otherwise>
		</choose>
		ORDER BY CNTR_BGN_DT DESC
	</select>

	<!-- 고객/계약조회(계약번호) -->
	<select id="selectCntrDetail" resultType="CustomerDomain" parameterType="CustomerDomain">
		SELECT
		    A.DLGT_UNTY_CSNO,
		    A.BZPL_UNTY_CSNO,
		    A.DDCT_BIZ_DSCD,
		    (SELECT CS_KRN_NM FROM IF_CM_UNTYCS_M
		    	WHERE UNTY_CSNO = #{untyCsno}) AS CS_KRN_NM,
		    (SELECT RL_CS_KRN_NM FROM IF_CM_UNTYCS_M
		    WHERE UNTY_CSNO = #{untyCsno}) AS RL_CS_KRN_NM,
		    (SELECT CS_DSCD FROM IF_CM_UNTYCS_M
		    	WHERE UNTY_CSNO = #{untyCsno}) AS CS_DSCD,
	    	(SELECT CS_SRCH_NO FROM IF_CM_UNTYCS_M
    			WHERE UNTY_CSNO = #{untyCsno}) AS CS_SRCH_NO,
		    A.CNTR_NO,
		    A.UNTY_CNTR_NO,
		    A.ABND_YN,
		    A.SMS_YN,
		    (SELECT BADR || ' ' || DADR FROM IF_CM_ADR_M
		    	WHERE UNTY_CNTR_NO = A.UNTY_CNTR_NO
		    	AND (UNTY_CSNO = A.DLGT_UNTY_CSNO OR UNTY_CSNO = A.BZPL_UNTY_CSNO)
		    	AND CS_ADR_POST_TRSPL_DSCD = A.POST_TRSPL_DSCD) AS ADDR,
		    #{tlno} AS TLNO,
		    #{untyCsno} AS UNTY_CSNO
	    FROM IF_CA_UNTYCNTR_M A
	    	WHERE A.UNTY_CNTR_NO = #{untyCntrNo}
	</select>

	<!-- 콜백선점여부 -->
	<select id="callbackYn" parameterType="java.lang.Integer" resultType="java.lang.String">
		SELECT PROC_YN FROM TH_CALLBACK WHERE CALLBACK_SEQ = #{callbackSeq}
	</select>

	<!-- 콜백선점ID체크 -->
	<select id="callbackModYn" parameterType="CallbackDomain" resultType="java.lang.Integer">
		SELECT COUNT(*) FROM TH_CALLBACK WHERE CALLBACK_SEQ = #{callbackSeq} AND MOD_ID = #{loginUserId}
	</select>

	<!-- 상담이력 리스트조회 -->
	<!-- <select id="selectConsultDetailList" resultType="ConsultDetailDomain">
		SELECT
		    A.*,
		    B.CUST_NM,
		    C.CODE_NAME,
		    (SELECT USER_NM FROM IF_CO_USER_MA WHERE USER_ID=A.USER_ID) AS USER_NM
		FROM TH_CONSULT_DETAIL A JOIN TH_CONSULT B
		   		ON A.CNLT_SEQ = B.CNLT_SEQ
		    JOIN TH_CODE C
		    	ON A.CNLT_PROC_CD = C.MCODE
		    WHERE C.LCODE='001'
		    ORDER BY A.CNLT_DATE DESC
	</select> -->

	<!-- 상담이력 선택조회(팝업) -->
	<select id="selectConsultInfoDetail" resultType="ConsultDetailDomain">
		SELECT
			(SELECT CODE_NAME FROM TH_CONSULT_CODE
				WHERE CHNL_CODE = A.CHNL_CODE AND LCODE='00') AS CODE_NAME,
			(SELECT CODE_NAME FROM TH_CONSULT_CODE
				WHERE CHNL_CODE = A.CHNL_CODE AND LCODE=A.LCODE AND MCODE='00' AND SCODE='00') AS LCODE,
			(SELECT CODE_NAME FROM TH_CONSULT_CODE
				WHERE CHNL_CODE = A.CHNL_CODE AND LCODE=A.LCODE AND MCODE=A.MCODE AND SCODE='00') AS MCODE,
			(SELECT CODE_NAME FROM TH_CONSULT_CODE
				WHERE CHNL_CODE = A.CHNL_CODE AND LCODE=A.LCODE AND MCODE=A.MCODE AND SCODE=A.SCODE) AS SCODE,
			(SELECT CUST_NM FROM TH_CONSULT
				WHERE CNLT_SEQ=A.CNLT_SEQ) AS CUST_NM,
			A.CNTR_NO,
			A.UNTY_CNTR_NO,
			A.RECV_NOTE,
			A.PROC_NOTE,
			A.TELL_NUM,
			A.REC_URL,
			A.CNLT_SEQ,
			A.CNLT_DETAIL_NO,
			A.IO_TYPE,
			(SELECT CUST_NO FROM TH_CONSULT WHERE CNLT_SEQ = #{cnltSeq}) AS CUST_NO
		FROM TH_CONSULT_DETAIL A
			WHERE A.CNLT_SEQ = #{cnltSeq} AND A.CNLT_DETAIL_NO = #{cnltDetailNo}
			ORDER BY A.CNLT_DATE DESC
	</select>

	<!-- 상담이력 검색 -->
	<select id="selectConsultSearch" resultType="ConsultDetailDomain" parameterType="ConsultDetailDomain">
	SELECT * FROM(
		SELECT C.*, ROWNUM AS RNUM
			FROM
			(SELECT A.*,
				(SELECT USER_NM FROM IF_CO_USER_MA WHERE USER_ID=A.USER_ID) AS USER_NM,
				B.CUST_NM,
				(SELECT CODE_NAME FROM TH_CODE WHERE LCODE='001' AND MCODE = A.CNLT_PROC_CD) AS CODE_NAME
			FROM TH_CONSULT_DETAIL A JOIN TH_CONSULT B
			ON A.CNLT_SEQ=B.CNLT_SEQ
			WHERE
			A.CNLT_DATE BETWEEN TO_DATE(TO_CHAR(SYSDATE,'YYYY-MM-DD'), 'YYYY-MM-DD')
			AND TO_DATE(TO_CHAR(SYSDATE+1,'YYYY-MM-DD'), 'YYYY-MM-DD')
			<if test=" userNm != null and userNm !='' ">
			AND A.USER_ID IN (SELECT USER_ID FROM IF_CO_USER_MA WHERE USER_NM = #{userNm})
			</if>
			<if test=" custNm != null and custNm !='' ">
			AND B.CUST_NM LIKE '%' || #{custNm} || '%'
			</if>
			<if test=" cnltProcCd != null and cnltProcCd !='' ">
			AND A.CNLT_PROC_CD = #{cnltProcCd}
			</if>
			ORDER BY A.CNLT_DATE DESC
			) C
			WHERE C.REG_ID = #{loginUserId} OR (SELECT CALL_AP_GRADE FROM IF_CO_USER_HI WHERE USER_ID = #{loginUserId}) IN ('01','02')
		)
		WHERE RNUM BETWEEN #{fromRowPerPage} AND #{toRowPerPage}
	</select>

	<!-- 상담이력 검색 -->
	<select id="selectConsultSearch2" resultType="ConsultDetailDomain" parameterType="ConsultDetailDomain">
	SELECT * FROM(
		SELECT C.*, ROWNUM AS RNUM
			FROM
			(SELECT A.*,
				(SELECT USER_NM FROM IF_CO_USER_MA WHERE USER_ID=A.USER_ID) AS USER_NM,
				B.CUST_NM,
				(SELECT CODE_NAME FROM TH_CODE WHERE LCODE='001' AND MCODE = A.CNLT_PROC_CD) AS CODE_NAME
			FROM TH_CONSULT_DETAIL A JOIN TH_CONSULT B
			ON A.CNLT_SEQ=B.CNLT_SEQ
			WHERE
			(B.CUST_NO = #{untyCsno} OR A.UNTY_CNTR_NO = #{untyCntrNo} OR A.TELL_NUM = #{tellNum})
			AND A.CNLT_DATE >= TO_DATE(#{startDate},'YYYY-MM-DD')
			AND A.CNLT_DATE <![CDATA[<]]> TO_DATE(#{endDate},'YYYY-MM-DD')+1
			<if test=" userNm != null and userNm !='' ">
			AND A.USER_ID IN (SELECT USER_ID FROM IF_CO_USER_MA WHERE USER_NM = #{userNm})
			</if>
			<if test=" custNm != null and custNm !='' ">
			AND B.CUST_NM LIKE '%' || #{custNm} || '%'
			</if>
			<if test=" cnltProcCd != null and cnltProcCd !='' ">
			AND A.CNLT_PROC_CD = #{cnltProcCd}
			</if>
			ORDER BY A.CNLT_DATE DESC
			) C
		)
		WHERE RNUM BETWEEN #{fromRowPerPage} AND #{toRowPerPage}
	</select>

	<select id="consultTotalCount2" resultType="java.lang.Integer" parameterType="ConsultDetailDomain">
	SELECT COUNT(*) FROM(
		SELECT C.*
			FROM
			(SELECT A.*,
				(SELECT USER_NM FROM IF_CO_USER_MA WHERE USER_ID=A.USER_ID) AS USER_NM,
				B.CUST_NM,
				(SELECT CODE_NAME FROM TH_CODE WHERE LCODE='001' AND MCODE = A.CNLT_PROC_CD) AS CODE_NAME
			FROM TH_CONSULT_DETAIL A JOIN TH_CONSULT B
			ON A.CNLT_SEQ=B.CNLT_SEQ
			WHERE
			(B.CUST_NO = #{untyCsno} OR A.UNTY_CNTR_NO = #{untyCntrNo} OR A.TELL_NUM = #{tellNum})
			AND A.CNLT_DATE >= TO_DATE(#{startDate},'YYYY-MM-DD')
			AND A.CNLT_DATE <![CDATA[<]]> TO_DATE(#{endDate},'YYYY-MM-DD')+1
			<if test=" userNm != null and userNm !='' ">
			AND A.USER_ID IN (SELECT USER_ID FROM IF_CO_USER_MA WHERE USER_NM = #{userNm})
			</if>
			<if test=" custNm != null and custNm !='' ">
			AND B.CUST_NM LIKE '%' || #{custNm} || '%'
			</if>
			<if test=" cnltProcCd != null and cnltProcCd !='' ">
			AND A.CNLT_PROC_CD = #{cnltProcCd}
			</if>
			ORDER BY A.CNLT_DATE DESC
			) C
		)
	</select>

	<!-- 상담이력 총개수 -->
	<select id="consultTotalCount" resultType="Integer" parameterType="ConsultDetailDomain">
	SELECT COUNT(*) FROM(
		SELECT C.*
			FROM
			(SELECT
				A.*
			FROM TH_CONSULT_DETAIL A JOIN TH_CONSULT B
			ON A.CNLT_SEQ=B.CNLT_SEQ
			WHERE
			A.CNLT_DATE BETWEEN TO_DATE(TO_CHAR(SYSDATE,'YYYY-MM-DD'), 'YYYY-MM-DD')
			AND TO_DATE(TO_CHAR(SYSDATE+1,'YYYY-MM-DD'), 'YYYY-MM-DD')
			<if test=" userNm != null and userNm !='' ">
			AND A.USER_ID IN (SELECT USER_ID FROM IF_CO_USER_MA WHERE USER_NM = #{userNm})
			</if>
			<if test=" custNm != null and custNm !='' ">
			AND B.CUST_NM LIKE '%' || #{custNm} || '%'
			</if>
			<if test=" cnltProcCd != null and cnltProcCd !='' ">
			AND A.CNLT_PROC_CD = #{cnltProcCd}
			</if>
			ORDER BY A.CNLT_DATE DESC
			) C
			WHERE C.REG_ID = #{loginUserId} OR (SELECT CALL_AP_GRADE FROM IF_CO_USER_HI WHERE USER_ID = #{loginUserId}) IN ('01','02')
		)
	</select>

	<!-- 상담내용 저장(마스터) -->
	<insert id="insertConsult" parameterType="ConsultDetailDomain" useGeneratedKeys="true" keyProperty="seq">
		INSERT INTO TH_CONSULT
		(CNLT_SEQ, CNLT_PROC_CD, CUST_NO,
		CUST_NM, REG_ID, REG_DATE,
		MOD_ID, MOD_DATE, JUMIN_TEMP)
		VALUES
		(
			(TO_CHAR(sysdate,'YYYYMMDD') || SEQ_TH_CONSULT.NEXTVAL), #{cnltProcCd},
			#{custNo}, #{custNm}, #{regId},
			sysdate, #{modId}, sysdate, #{juminTemp}
		)
		<selectKey keyProperty="seq" order="AFTER" resultType="Integer">
			SELECT SEQ_TH_CONSULT.CURRVAL FROM DUAL
		</selectKey>
	</insert>

	<!-- 상담마스터 테이블 최종 처리상태 업데이트 -->
	<update id="updateConsult" parameterType="ConsultDetailDomain">
		UPDATE TH_CONSULT SET
			CNLT_PROC_CD = #{cnltProcCd},
			MOD_ID = #{loginUserId},
			MOD_DATE = SYSDATE
		WHERE CNLT_SEQ = #{cnltSeq}
	</update>

	<!-- 상담 상세 개수 -->
	<!-- <select id="curDetailNo" resultType="Integer" parameterType="ConsultDetailDomain">
		SELECT COUNT(CNLT_DETAIL_NO) FROM TH_CONSULT_DETAIL WHERE CNLT_SEQ=#{cnltSeq}
	</select> -->

	<!-- 상담내용 저장(디테일) -->
	<insert id="insertConsultDetail" parameterType="ConsultDetailDomain">
			INSERT INTO TH_CONSULT_DETAIL
			(
				CNLT_SEQ, CNLT_DETAIL_NO, CNLT_PROC_CD,
				CNLT_DATE, UNTY_CNTR_NO, CNTR_NO,
				CALL_START_DATE, CALL_END_DATE,
				TELL_NUM, CALL_YN, IO_TYPE,
				REC_URL, REC_KEY, RECV_NOTE,
				PROC_NOTE, USER_ID, CHNL_CODE,
				SCODE, MCODE, LCODE,
				TRAN_ID, RSRV_DATE, RSRV_TELL_NUM,
				CALLBACK_SEQ, REG_ID, REG_DATE,
				MOD_ID, MOD_DATE
			)
			VALUES
			(
				#{cnltSeq}, #{cnltDetailNo}, #{cnltProcCd},
				<if test=" cnltDate != null and cnltDate !='' ">
				TO_DATE(#{cnltDate},'YYYY-MM-DD HH24:MI:SS'),
				</if>
				<if test=" cnltDate == null or cnltDate =='' ">
					sysdate,
				</if>
				#{untyCntrNo, jdbcType=VARCHAR}, #{cntrNo, jdbcType=VARCHAR},
				<if test=" callStartDate != null and callStartDate !='' ">
				TO_DATE(#{callStartDate},'YYYY-MM-DD HH24:MI:SS'),
				</if>
				<if test=" callStartDate == null or callStartDate =='' ">
					sysdate,
				</if>
				TO_DATE(#{callEndDate},'YYYY-MM-DD HH24:MI:SS'),
				#{tellNum}, #{callYn}, #{ioType},
				#{recUrl}, '', #{recvNote},
				#{procNote}, #{userId}, #{chnlCode},
				#{scode}, #{mcode}, #{lcode},
				#{tranId, jdbcType=VARCHAR}, TO_DATE(#{rsrvDate, jdbcType=VARCHAR},'YYYY-MM-DD HH24:MI:SS'),
				#{rsrvTellNum, jdbcType=VARCHAR}, #{callbackSeq, jdbcType=VARCHAR},
				#{regId}, sysdate,
				#{modId}, sysdate
			)
	</insert>

	<!-- 특이성향 저장 -->
	<insert id="insertSpecial" parameterType="ConsultDetailDomain">
		INSERT INTO TH_SPECIAL_CUST
		(
			CNLT_SEQ, CNLT_DETAIL_NO, UNTY_CSNO,
			<if test=" custNo == null or custNo == '' ">
			TELL_NUM,
			</if>
			SPCL_CONT, SPCL_APPV_YN,
			REG_ID, REG_DATE, MOD_ID, MOD_DATE,
			JUMIN_TEMP
		)
		VALUES
		(
			#{cnltSeq}, #{cnltDetailNo}, #{custNo},
			<if test=" custNo == null or custNo == '' ">
			#{tellNum},
			</if>
			#{spclCont}, 'N',
			#{regId}, sysdate, #{modId}, sysdate,
			#{juminTemp}
		)
	</insert>

	<!-- 예약저장 -->
	<insert id="insertRsrv" parameterType="ConsultDetailDomain">
		INSERT INTO TH_RESERVE
		(
			CNLT_SEQ, CNLT_DETAIL_NO, REG_ID,
			REG_DATE, MOD_ID, MOD_DATE
		)
		VALUES
		(
			#{cnltSeq}, #{cnltDetailNo}, #{regId},
			sysdate, #{modId}, sysdate
		)
	</insert>

	<!-- 이관저장 -->
	<insert id="insertTran" parameterType="ConsultDetailDomain">
		INSERT INTO TH_TRANSFER
		(
			CNLT_SEQ, CNLT_DETAIL_NO, REG_ID,
			REG_DATE, MOD_ID, MOD_DATE
		)
		VALUES
		(
			#{cnltSeq}, #{cnltDetailNo}, #{regId},
			sysdate, #{modId}, sysdate
		)
	</insert>

	<!-- 콜백 리스트 -->
	<select id="selectCallbackList" resultType="CallbackDomain">
		 SELECT * FROM
			(SELECT B.*, ROWNUM AS RNUM
				FROM
			(
				(
					<if test=" allOrMy != null and allOrMy == 'all'.toString() ">
					SELECT
					    A.CALLBACK_SEQ,
					    A.CALLBACK_DATE,
					    A.CALLBACK_NUM,
					    (SELECT CODE_NAME FROM TH_CONSULT_CODE
					    WHERE A.CHNL_CODE=CHNL_CODE AND LCODE='00') AS CODE_NAME,
					    A.PROC_YN,
					    A.MOD_ID,
					    A.REG_DATE,
					    A.CHNL_CODE
					FROM TH_CALLBACK A
					WHERE
					    A.REG_DATE BETWEEN TO_DATE(TO_CHAR(SYSDATE,'YYYY-MM-DD'), 'YYYY-MM-DD')
					    AND TO_DATE(TO_CHAR(SYSDATE+1,'YYYY-MM-DD'), 'YYYY-MM-DD')
					    AND A.PROC_YN = 'N'
					     <if test=" chnlCode != null and chnlCode != '' ">
					    	AND A.CHNL_CODE = #{chnlCode}
					    </if>
					UNION ALL
					</if>
					SELECT
					    CALLBACK_SEQ,
					    CALLBACK_DATE,
					    CALLBACK_NUM,
					    CODE_NAME,
					    PROC_YN,
					    MOD_ID,
					    REG_DATE,
					    CHNL_CODE
					FROM
					(
					    SELECT CD.CALLBACK_SEQ AS CD_CB, CB.CALLBACK_SEQ AS CB_CB,
					    CB.CALLBACK_SEQ,
					    CB.CALLBACK_DATE,
					    CB.CALLBACK_NUM,
					    (SELECT CODE_NAME FROM TH_CONSULT_CODE
					    WHERE CB.CHNL_CODE=CHNL_CODE AND LCODE='00') AS CODE_NAME,
					    CB.PROC_YN,
					    CB.MOD_ID,
					    CB.REG_DATE,
					    CB.CHNL_CODE
					    FROM
					    TH_CONSULT_DETAIL CD, TH_CALLBACK CB
					    WHERE CD.CALLBACK_SEQ(+) = CB.CALLBACK_SEQ
					    AND CB.REG_DATE BETWEEN TO_DATE(TO_CHAR(SYSDATE,'YYYY-MM-DD'), 'YYYY-MM-DD')
					    AND TO_DATE(TO_CHAR(SYSDATE+1,'YYYY-MM-DD'), 'YYYY-MM-DD')
					    AND CB.PROC_YN = 'Y'
					    <if test=" allOrMy != null and allOrMy == 'my'.toString() ">
							AND CB.MOD_ID = #{loginUserId}
						</if>
						<if test=" chnlCode != null and chnlCode != '' ">
					    	AND CB.CHNL_CODE = #{chnlCode}
					    </if>
					)WHERE CD_CB IS NULL
				) ORDER BY REG_DATE ASC
			) B
		) WHERE RNUM BETWEEN #{fromRowPerPage} AND #{toRowPerPage}
	</select>

	<!-- 콜백 총개수 -->
	<select id="callbackTotalCount" parameterType="CallbackDomain" resultType="Integer">
		SELECT COUNT(*) FROM
			(
				(
				<if test=" allOrMy != null and allOrMy == 'all'.toString() ">
				SELECT
				    A.CALLBACK_SEQ,
				    A.CALLBACK_DATE,
				    A.CALLBACK_NUM,
				    (SELECT CODE_NAME FROM TH_CONSULT_CODE
				    WHERE A.CHNL_CODE=CHNL_CODE AND LCODE='00') AS CODE_NAME,
				    A.PROC_YN,
				    A.MOD_ID,
				    A.REG_DATE
				FROM TH_CALLBACK A
				WHERE
				    A.REG_DATE BETWEEN TO_DATE(TO_CHAR(SYSDATE,'YYYY-MM-DD'), 'YYYY-MM-DD')
				    AND TO_DATE(TO_CHAR(SYSDATE+1,'YYYY-MM-DD'), 'YYYY-MM-DD')
				    AND A.PROC_YN = 'N'
				    <if test=" chnlCode != null and chnlCode != '' ">
				    	AND A.CHNL_CODE = #{chnlCode}
				    </if>
				UNION ALL
				</if>
				SELECT
				    CALLBACK_SEQ,
				    CALLBACK_DATE,
				    CALLBACK_NUM,
				    CODE_NAME,
				    PROC_YN,
				    MOD_ID,
				    REG_DATE
				FROM
				(
				    SELECT CD.CALLBACK_SEQ AS CD_CB, CB.CALLBACK_SEQ AS CB_CB,
				    CB.CALLBACK_SEQ,
				    CB.CALLBACK_DATE,
				    CB.CALLBACK_NUM,
				    (SELECT CODE_NAME FROM TH_CONSULT_CODE
				    WHERE CB.CHNL_CODE=CHNL_CODE AND LCODE='00') AS CODE_NAME,
				    CB.PROC_YN,
				    CB.MOD_ID,
				    CB.REG_DATE
				    FROM
				    TH_CONSULT_DETAIL CD, TH_CALLBACK CB
				    WHERE CD.CALLBACK_SEQ(+) = CB.CALLBACK_SEQ
				    AND CB.REG_DATE BETWEEN TO_DATE(TO_CHAR(SYSDATE,'YYYY-MM-DD'), 'YYYY-MM-DD')
				    AND TO_DATE(TO_CHAR(SYSDATE+1,'YYYY-MM-DD'), 'YYYY-MM-DD')
				    AND CB.PROC_YN = 'Y'
				    <if test=" allOrMy != null and allOrMy == 'my'.toString() ">
						AND CB.MOD_ID = #{loginUserId}
					</if>
					<if test=" chnlCode != null and chnlCode != '' ">
						AND CB.CHNL_CODE = #{chnlCode}
				    </if>
				)WHERE CD_CB IS NULL) ORDER BY REG_DATE ASC
			) B
	</select>

	<!-- 콜백 선점 -->
	<update id="callBackProc" parameterType="CallbackDomain">
		UPDATE TH_CALLBACK SET
			PROC_YN = 'Y',
			MOD_ID = #{loginUserId},
			MOD_DATE = SYSDATE
		WHERE CALLBACK_SEQ = #{callbackSeq}
	</update>

	<!-- 예약전화 리스트 -->
	<select id="selectRsrvList" resultType="ConsultDetailDomain">
		 SELECT * FROM
			(SELECT E.*, ROWNUM AS RNUM
				FROM
				(SELECT
					A.CNLT_DATE, A.RSRV_DATE, A.RSRV_TELL_NUM,
					A.CNLT_SEQ, A.CNLT_DETAIL_NO,
					D.USER_NM, C.CUST_NM
				FROM
					TH_CONSULT_DETAIL A JOIN TH_CONSULT C
		        		ON A.CNLT_SEQ = C.CNLT_SEQ
		        		AND A.CNLT_PROC_CD = '02'
		        	JOIN IF_CO_USER_MA D
		        		ON D.USER_ID = A.REG_ID
		        	JOIN
                    (SELECT
					A.CNLT_SEQ, MAX(A.CNLT_DETAIL_NO) AS CNLT_DETAIL_NO
					FROM
					TH_CONSULT_DETAIL A JOIN TH_CONSULT C
		        		ON A.CNLT_SEQ = C.CNLT_SEQ
		        		AND C.CNLT_PROC_CD = '02'
                        GROUP BY A.CNLT_SEQ) S
                    ON A.CNLT_SEQ = S.CNLT_SEQ
                    AND A.CNLT_DETAIL_NO = S.CNLT_DETAIL_NO
		        	WHERE
			        	A.REG_ID = #{loginUserId}
			        	OR (SELECT CALL_AP_GRADE FROM IF_CO_USER_HI WHERE USER_ID = #{loginUserId}) IN ('01','02')
			        ORDER BY A.RSRV_DATE DESC) E
	   	 ) WHERE RNUM BETWEEN #{fromRowPerPage} AND #{toRowPerPage}
	</select>

	<!-- 예약전화 총개수 -->
	<select id="reserveTotalCount" parameterType="ConsultDetailDomain" resultType="Integer">
		SELECT COUNT(*)
				FROM
				(SELECT
					A.CNLT_DATE, A.RSRV_DATE, A.RSRV_TELL_NUM,
					A.CNLT_SEQ, A.CNLT_DETAIL_NO,
					D.USER_NM, C.CUST_NM
				FROM
					TH_CONSULT_DETAIL A JOIN TH_CONSULT C
		        		ON A.CNLT_SEQ = C.CNLT_SEQ
		        		AND A.CNLT_PROC_CD = '02'
		        	JOIN IF_CO_USER_MA D
		        		ON D.USER_ID = A.REG_ID
		        	JOIN
                    (SELECT
					A.CNLT_SEQ, MAX(A.CNLT_DETAIL_NO) AS CNLT_DETAIL_NO
					FROM
					TH_CONSULT_DETAIL A JOIN TH_CONSULT C
		        		ON A.CNLT_SEQ = C.CNLT_SEQ
		        		AND C.CNLT_PROC_CD = '02'
                        GROUP BY A.CNLT_SEQ) S
                    ON A.CNLT_SEQ = S.CNLT_SEQ
                    AND A.CNLT_DETAIL_NO = S.CNLT_DETAIL_NO
		        	WHERE
			        	A.REG_ID = #{loginUserId}
			        	OR (SELECT CALL_AP_GRADE FROM IF_CO_USER_HI WHERE USER_ID = #{loginUserId}) IN ('01','02')
			        ORDER BY A.RSRV_DATE DESC)
	</select>

	<!-- 예약전화 총개수(메인) -->
	<select id="reserveTotalCount2" parameterType="ConsultDetailDomain" resultType="Integer">
		SELECT COUNT(*)
				FROM
				(SELECT
					A.CNLT_DATE, A.RSRV_DATE, A.RSRV_TELL_NUM,
					A.CNLT_SEQ, A.CNLT_DETAIL_NO,
					D.USER_NM, C.CUST_NM
				FROM
					TH_CONSULT_DETAIL A JOIN TH_CONSULT C
		        		ON A.CNLT_SEQ = C.CNLT_SEQ
		        		AND A.CNLT_PROC_CD = '02'
		        	JOIN IF_CO_USER_MA D
		        		ON D.USER_ID = A.REG_ID
		        	JOIN
                    (SELECT
					A.CNLT_SEQ, MAX(A.CNLT_DETAIL_NO) AS CNLT_DETAIL_NO
					FROM
					TH_CONSULT_DETAIL A JOIN TH_CONSULT C
		        		ON A.CNLT_SEQ = C.CNLT_SEQ
		        		AND C.CNLT_PROC_CD = '02'
                        GROUP BY A.CNLT_SEQ) S
                    ON A.CNLT_SEQ = S.CNLT_SEQ
                    AND A.CNLT_DETAIL_NO = S.CNLT_DETAIL_NO
		        	WHERE
			        	A.REG_ID = #{loginUserId}
			        ORDER BY A.RSRV_DATE DESC)
	</select>

	<!-- 예약전화 상세조회(상담정보) -->
	<select id="selectConsultRsrvDetail" parameterType="ConsultDetailDomain" resultType="ConsultDetailDomain">
	SELECT
			A.*,
			B.CNLT_SEQ, B.CNLT_DETAIL_NO,
			D.USER_NM, C.CUST_NM
		FROM
			TH_CONSULT_DETAIL A JOIN TH_RESERVE B
				ON A.CNLT_SEQ = B.CNLT_SEQ
			AND A.CNLT_DETAIL_NO = B.CNLT_DETAIL_NO
	        JOIN TH_CONSULT C
	        	ON A.CNLT_SEQ = C.CNLT_SEQ
	        JOIN IF_CO_USER_MA D
	       		ON D.USER_ID = A.USER_ID
	        	WHERE B.CNLT_SEQ=#{cnltSeq}
				AND B.CNLT_DETAIL_NO=#{cnltDetailNo}
	</select>

	<!-- 예약전화 상세조회(고객정보) -->
	<select id="selectConsultRsrvDetail2" parameterType="ConsultDetailDomain" resultType="CustomerDomain">
		SELECT
			A.CNTR_NO,
			B.CUST_NO AS UNTY_CSNO,
			A.TELL_NUM AS TLNO,
			A.UNTY_CNTR_NO
		FROM TH_CONSULT_DETAIL A JOIN TH_CONSULT B
	    	ON A.CNLT_SEQ = B.CNLT_SEQ
	    	WHERE
	    	A.CNLT_SEQ=#{cnltSeq}
	    	AND A.CNLT_DETAIL_NO = #{cnltDetailNo}
	</select>

	<!-- 이관내역 상세조회(상담정보) -->
	<select id="selectConsultTranDetail" parameterType="ConsultDetailDomain" resultType="ConsultDetailDomain">
	SELECT
			A.*,
			B.CNLT_SEQ, B.CNLT_DETAIL_NO,
			D.USER_NM, C.CUST_NM
		FROM
			TH_CONSULT_DETAIL A JOIN TH_TRANSFER B
				ON A.CNLT_SEQ = B.CNLT_SEQ
			AND A.CNLT_DETAIL_NO = B.CNLT_DETAIL_NO
	        JOIN TH_CONSULT C
	        	ON A.CNLT_SEQ = C.CNLT_SEQ
	        JOIN IF_CO_USER_MA D
	       		ON D.USER_ID = A.USER_ID
	        	WHERE B.CNLT_SEQ=#{cnltSeq}
				AND B.CNLT_DETAIL_NO=#{cnltDetailNo}
	</select>

	<!-- 이관내역 상세조회(고객정보) -->
	<select id="selectConsultTranDetail2" parameterType="ConsultDetailDomain" resultType="CustomerDomain">
		SELECT
			A.CNTR_NO,
			B.CUST_NO AS UNTY_CSNO,
			A.TELL_NUM AS TLNO,
			A.UNTY_CNTR_NO
		FROM TH_CONSULT_DETAIL A JOIN TH_CONSULT B
	    	ON A.CNLT_SEQ = B.CNLT_SEQ
	    	WHERE
	    	A.CNLT_SEQ=#{cnltSeq}
	    	AND A.CNLT_DETAIL_NO = #{cnltDetailNo}
	</select>

	<!-- 이관내역 리스트 -->
	<select id="selectTransList" resultType="ConsultDetailDomain">
		SELECT * FROM
			(SELECT E.*, ROWNUM AS RNUM FROM
				(SELECT
					A.CNLT_DATE, A.TRAN_ID, A.TELL_NUM,
					(SELECT USER_NM FROM IF_CO_USER_MA WHERE USER_ID=B.REG_ID) AS REG_NM,
					A.CNLT_SEQ, A.CNLT_DETAIL_NO,
					(SELECT USER_NM FROM IF_CO_USER_MA WHERE USER_ID=A.TRAN_ID) AS TRAN_NM,
					(SELECT CUST_NM FROM TH_CONSULT WHERE A.CNLT_SEQ = CNLT_SEQ) AS CUST_NM,
					(SELECT CODE_NAME FROM TH_CODE WHERE LCODE='001' AND MCODE = A.CNLT_PROC_CD) AS CODE_NAME,
					A.CNLT_PROC_CD
				FROM
					TH_CONSULT_DETAIL A JOIN TH_CONSULT B
						ON A.CNLT_SEQ = B.CNLT_SEQ
						AND A.CNLT_PROC_CD IN ('03','04','07')
                    	JOIN
                    (SELECT
					A.CNLT_SEQ, MAX(A.CNLT_DETAIL_NO) AS CNLT_DETAIL_NO
					FROM
					TH_CONSULT_DETAIL A JOIN TH_CONSULT C
                    ON A.CNLT_SEQ = C.CNLT_SEQ
		        	AND C.CNLT_PROC_CD IN ('03','04','07')
                    GROUP BY A.CNLT_SEQ) S
                    	ON A.CNLT_SEQ = S.CNLT_SEQ
                   		AND A.CNLT_DETAIL_NO = S.CNLT_DETAIL_NO
		        	WHERE
                        A.TRAN_ID = #{loginUserId}
		        		OR B.REG_ID = #{loginUserId}
		        		OR (SELECT CALL_AP_GRADE FROM IF_CO_USER_HI WHERE USER_ID = #{loginUserId}) IN ('01','02')
		        		ORDER BY A.REG_DATE DESC) E
		      )
		      WHERE RNUM BETWEEN #{fromRowPerPage} AND #{toRowPerPage}
	</select>

	<!-- 이관내역 총개수 -->
	<select id="transferTotalCount" parameterType="ConsultDetailDomain" resultType="Integer">
			SELECT COUNT(*) FROM
				(SELECT E.*, ROWNUM AS RNUM FROM
				(SELECT
					A.CNLT_DATE, A.TRAN_ID, A.TELL_NUM,
					(SELECT USER_NM FROM IF_CO_USER_MA WHERE USER_ID=B.REG_ID) AS REG_NM,
					A.CNLT_SEQ, A.CNLT_DETAIL_NO,
					(SELECT USER_NM FROM IF_CO_USER_MA WHERE USER_ID=A.TRAN_ID) AS TRAN_NM,
					(SELECT CUST_NM FROM TH_CONSULT WHERE A.CNLT_SEQ = CNLT_SEQ) AS CUST_NM,
					(SELECT CODE_NAME FROM TH_CODE WHERE LCODE='001' AND MCODE = A.CNLT_PROC_CD) AS CODE_NAME,
					A.CNLT_PROC_CD
				FROM
					TH_CONSULT_DETAIL A JOIN TH_CONSULT B
						ON A.CNLT_SEQ = B.CNLT_SEQ
						AND A.CNLT_PROC_CD IN ('03','04','07')
	                    JOIN
                    (SELECT
					A.CNLT_SEQ, MAX(A.CNLT_DETAIL_NO) AS CNLT_DETAIL_NO
					FROM
					TH_CONSULT_DETAIL A JOIN TH_CONSULT C
                    ON A.CNLT_SEQ = C.CNLT_SEQ
		        	AND C.CNLT_PROC_CD IN ('03','04','07')
                    GROUP BY A.CNLT_SEQ) S
                    	ON A.CNLT_SEQ = S.CNLT_SEQ
                   		AND A.CNLT_DETAIL_NO = S.CNLT_DETAIL_NO
		        	WHERE
                        A.TRAN_ID = #{loginUserId}
		        		OR B.REG_ID = #{loginUserId}
		        		OR (SELECT CALL_AP_GRADE FROM IF_CO_USER_HI WHERE USER_ID = #{loginUserId}) IN ('01','02')
		        		ORDER BY A.REG_DATE DESC) E
		      	)
	</select>

	<!-- 이관내역 총개수(메인) -->
	<select id="transferTotalCount2" parameterType="ConsultDetailDomain" resultType="Integer">
			SELECT COUNT(*) FROM
				(SELECT E.*, ROWNUM AS RNUM FROM
				(SELECT
					A.CNLT_DATE, A.TRAN_ID, A.TELL_NUM,
					(SELECT USER_NM FROM IF_CO_USER_MA WHERE USER_ID=B.REG_ID) AS REG_NM,
					A.CNLT_SEQ, A.CNLT_DETAIL_NO,
					(SELECT USER_NM FROM IF_CO_USER_MA WHERE USER_ID=A.TRAN_ID) AS TRAN_NM,
					(SELECT CUST_NM FROM TH_CONSULT WHERE A.CNLT_SEQ = CNLT_SEQ) AS CUST_NM,
					(SELECT CODE_NAME FROM TH_CODE WHERE LCODE='001' AND MCODE = A.CNLT_PROC_CD) AS CODE_NAME,
					A.CNLT_PROC_CD
				FROM
					TH_CONSULT_DETAIL A JOIN TH_CONSULT B
						ON A.CNLT_SEQ = B.CNLT_SEQ
						AND A.CNLT_PROC_CD IN ('03','04','07')
                    	JOIN
                    (SELECT
					A.CNLT_SEQ, MAX(A.CNLT_DETAIL_NO) AS CNLT_DETAIL_NO
					FROM
					TH_CONSULT_DETAIL A JOIN TH_CONSULT C
                    ON A.CNLT_SEQ = C.CNLT_SEQ
		        	AND C.CNLT_PROC_CD IN ('03','04','07')
                    GROUP BY A.CNLT_SEQ) S
                    	ON A.CNLT_SEQ = S.CNLT_SEQ
                   		AND A.CNLT_DETAIL_NO = S.CNLT_DETAIL_NO
		        	WHERE
                        A.TRAN_ID = #{loginUserId}
		        		ORDER BY A.REG_DATE DESC) E
		      	)
	</select>

	<!-- 이관내역 총개수(탑) -->
	<select id="transferTotalCount3" parameterType="ConsultDetailDomain" resultType="Integer">
			SELECT COUNT(*) FROM
				(SELECT E.*, ROWNUM AS RNUM FROM
				(SELECT
					A.CNLT_DATE, A.TRAN_ID, A.TELL_NUM,
					(SELECT USER_NM FROM IF_CO_USER_MA WHERE USER_ID=B.REG_ID) AS REG_NM,
					A.CNLT_SEQ, A.CNLT_DETAIL_NO,
					(SELECT USER_NM FROM IF_CO_USER_MA WHERE USER_ID=A.TRAN_ID) AS TRAN_NM,
					(SELECT CUST_NM FROM TH_CONSULT WHERE A.CNLT_SEQ = CNLT_SEQ) AS CUST_NM,
					(SELECT CODE_NAME FROM TH_CODE WHERE LCODE='001' AND MCODE = A.CNLT_PROC_CD) AS CODE_NAME,
					A.CNLT_PROC_CD
				FROM
					TH_CONSULT_DETAIL A JOIN TH_CONSULT B
						ON A.CNLT_SEQ = B.CNLT_SEQ
						AND A.CNLT_PROC_CD IN ('03','04','07')
						AND A.REG_DATE BETWEEN TO_DATE(TO_CHAR(SYSDATE,'YYYY-MM-DD'), 'YYYY-MM-DD')
						AND TO_DATE(TO_CHAR(SYSDATE+1,'YYYY-MM-DD'), 'YYYY-MM-DD')
                    	JOIN
                    (SELECT
					A.CNLT_SEQ, MAX(A.CNLT_DETAIL_NO) AS CNLT_DETAIL_NO
					FROM
					TH_CONSULT_DETAIL A JOIN TH_CONSULT C
                    ON A.CNLT_SEQ = C.CNLT_SEQ
		        	AND C.CNLT_PROC_CD IN ('03','04','07')
                    GROUP BY A.CNLT_SEQ) S
                    	ON A.CNLT_SEQ = S.CNLT_SEQ
                   		AND A.CNLT_DETAIL_NO = S.CNLT_DETAIL_NO
		        	WHERE
                        A.TRAN_ID = #{loginUserId}
		        		ORDER BY A.REG_DATE DESC) E
		      	)
	</select>

	<!-- 스크립트 리스트 -->
	<select id="selectScript" resultType="CodeDomain">
		SELECT * FROM(
			SELECT C.*, ROWNUM AS RNUM FROM
	            (SELECT
		            A.CHNL_CODE,
		            A.LCODE,
		            (SELECT CODE_NAME FROM TH_CONSULT_CODE
		            WHERE CHNL_CODE = #{chnlCode} AND LCODE=A.LCODE
		            AND MCODE='00' AND SCODE='00') AS LCODE_NAME,
		            A.MCODE,
		            (SELECT CODE_NAME FROM TH_CONSULT_CODE
		            WHERE CHNL_CODE = #{chnlCode} AND LCODE=A.LCODE
		            AND MCODE=A.MCODE AND SCODE='00') AS MCODE_NAME,
		            A.SCODE,
		             (SELECT CODE_NAME FROM TH_CONSULT_CODE
		            WHERE CHNL_CODE = #{chnlCode} AND LCODE=A.LCODE
		            AND MCODE=A.MCODE AND SCODE=A.SCODE) AS SCODE_NAME,
		            A.MOD_DATE,
		            (SELECT USER_NM FROM IF_CO_USER_MA WHERE USER_ID = A.REG_ID) AS REG_NM,
		            A.UPLOAD_FILE
		            FROM TH_CONSULT_CODE A JOIN
                    (SELECT DISTINCT(CHNL_CODE||LCODE||MCODE||SCODE), CHNL_CODE, LCODE, MCODE, SCODE FROM TH_SCRIPT) B
                    ON A.CHNL_CODE = B.CHNL_CODE
                    AND A.LCODE = B.LCODE
                    AND A.MCODE = B.MCODE
                    AND A.SCODE = B.SCODE
		            WHERE
		            A.CHNL_CODE = #{chnlCode} AND A.LCODE != '00'
		            AND A.MCODE != '00' AND A.SCODE != '00'
		            ORDER BY A.CHNL_CODE, A.LCODE, A.MCODE, A.SCODE ASC ) C
	        		WHERE 1=1
	        	<if test="keyword != null and keyword != '' ">
					AND (C.LCODE_NAME like '%' || #{keyword} || '%' OR
				    C.MCODE_NAME like '%' || #{keyword} || '%' OR
					C.SCODE_NAME like '%' || #{keyword} || '%')
				</if>
				<if test="lcode != null and lcode != '' ">
					AND C.LCODE = #{lcode}
	        	</if>
	        	<if test="mcode != null and mcode != '' ">
					AND C.MCODE = #{mcode}
				</if>
			) WHERE RNUM BETWEEN #{fromRowPerPage} AND #{toRowPerPage}
	</select>

	<!-- 스크립트 총개수 -->
	<select id="scriptTotalCount" parameterType="CodeDomain" resultType="Integer">
			SELECT COUNT(*) FROM
	            (SELECT
		            A.CHNL_CODE,
		            A.LCODE,
		            (SELECT CODE_NAME FROM TH_CONSULT_CODE
		            WHERE CHNL_CODE = #{chnlCode} AND LCODE=A.LCODE
		            AND MCODE='00' AND SCODE='00') AS LCODE_NAME,
		            A.MCODE,
		            (SELECT CODE_NAME FROM TH_CONSULT_CODE
		            WHERE CHNL_CODE = #{chnlCode} AND LCODE=A.LCODE
		            AND MCODE=A.MCODE AND SCODE='00') AS MCODE_NAME,
		            A.SCODE,
		             (SELECT CODE_NAME FROM TH_CONSULT_CODE
		            WHERE CHNL_CODE = #{chnlCode} AND LCODE=A.LCODE
		            AND MCODE=A.MCODE AND SCODE=A.SCODE) AS SCODE_NAME,
		            A.MOD_DATE,
		            (SELECT USER_NM FROM IF_CO_USER_MA WHERE USER_ID = A.REG_ID) AS REG_NM,
		            A.UPLOAD_FILE
		            FROM TH_CONSULT_CODE A JOIN
                    (SELECT DISTINCT(CHNL_CODE||LCODE||MCODE||SCODE), CHNL_CODE, LCODE, MCODE, SCODE FROM TH_SCRIPT) B
                    ON A.CHNL_CODE = B.CHNL_CODE
                    AND A.LCODE = B.LCODE
                    AND A.MCODE = B.MCODE
                    AND A.SCODE = B.SCODE
		            WHERE
		            A.CHNL_CODE = #{chnlCode} AND A.LCODE != '00'
		            AND A.MCODE != '00' AND A.SCODE != '00'
		            ORDER BY A.CHNL_CODE, A.LCODE, A.MCODE, A.SCODE ASC  ) C
	        		WHERE 1=1
	        	<if test="keyword != null and keyword != '' ">
					AND (C.LCODE_NAME like '%' || #{keyword} || '%' OR
				    C.MCODE_NAME like '%' || #{keyword} || '%' OR
					C.SCODE_NAME like '%' || #{keyword} || '%')
				</if>
				<if test="lcode != null and lcode != '' ">
					AND C.LCODE = #{lcode}
	        	</if>
	        	<if test="mcode != null and mcode != '' ">
					AND C.MCODE = #{mcode}
				</if>
	</select>

	<!-- 스크립트 조회2 -->
	<select id="selectScript2" parameterType="CodeDomain" resultType="ScriptDomain">
		SELECT *
            FROM (
                SELECT
                    A.*, ROWNUM AS RNUM
                    FROM (
                           SELECT
                           SCRP_NO, SCRP_TITLE, SCRP_CONT,
                           SCRP_FILE, CHNL_CODE, LCODE,
					       MCODE, SCODE
					       FROM TH_SCRIPT
					      WHERE CHNL_CODE = #{chnlCode}
					          AND LCODE = #{lcode}
					          AND MCODE = #{mcode}
					          AND SCODE = #{scode}
                          ORDER BY SCRP_NO DESC
                           ) A
                 )
         WHERE RNUM BETWEEN #{fromRowPerPage} AND #{toRowPerPage}
	</select>

	<!-- 스크립트 조회2 총개수 -->
	<select id="scriptTotalCount2" parameterType="CodeDomain" resultType="Integer">
		SELECT COUNT(*) FROM (
			SELECT
				A.*, ROWNUM AS RNUM FROM (
                SELECT
	                SCRP_NO, SCRP_TITLE, SCRP_CONT,
	                SCRP_FILE, CHNL_CODE, LCODE,
					MCODE, SCODE
					FROM TH_SCRIPT
					WHERE CHNL_CODE = #{chnlCode}
					AND LCODE = #{lcode}
					AND MCODE = #{mcode}
					AND SCODE = #{scode}
					ORDER BY SCRP_NO DESC
				) A
		)
	</select>

	<!-- 스크립트 상세 -->
	<select id="selectScriptDetail" parameterType="java.lang.String" resultType="ScriptDomain">
		SELECT CHNL_CODE,
              CHNL_CODE_NAME,
              LCODE,
              LCODE_NAME,
              MCODE,
              MCODE_NAME,
              SCODE,
              SCODE_NAME,
              SCRP_TITLE,
              SCRP_CONT,
              SCRP_FILE,
              SCRP_NO
      FROM (
		 SELECT CHNL_CODE,
				    (SELECT CODE_NAME FROM TH_CONSULT_CODE WHERE CHNL_CODE = TCC.CHNL_CODE AND LCODE='00' AND MCODE='00' AND SCODE='00') AS CHNL_CODE_NAME ,
					LCODE ,
					(SELECT CODE_NAME FROM TH_CONSULT_CODE WHERE CHNL_CODE = TCC.CHNL_CODE AND LCODE=TCC.LCODE AND LCODE <![CDATA[<>]]> '00' AND MCODE='00' AND SCODE='00') AS LCODE_NAME ,
					MCODE ,
					(SELECT CODE_NAME FROM TH_CONSULT_CODE WHERE CHNL_CODE = TCC.CHNL_CODE AND LCODE=TCC.LCODE AND MCODE=TCC.MCODE AND MCODE <![CDATA[<>]]> '00' AND SCODE='00') AS MCODE_NAME ,
					SCODE,
					 (SELECT CODE_NAME FROM TH_CONSULT_CODE WHERE CHNL_CODE = TCC.CHNL_CODE AND LCODE=TCC.LCODE AND MCODE=TCC.MCODE AND SCODE=TCC.SCODE AND SCODE <![CDATA[<>]]> '00') AS SCODE_NAME  ,
					SCRP_TITLE,
					SCRP_CONT,
					SCRP_FILE,
					SCRP_NO
	           FROM TH_SCRIPT TCC
	        WHERE 1=1
	             AND SCRP_NO = #{scrpNo}
	   )
	</select>

	<!-- 코드조회 -->
	<select id="selectCode" resultType="CodeDomain">
		SELECT * FROM TH_CODE WHERE USE_YN = 'Y' ORDER BY SORT_IDX ASC
	</select>

	<!-- 상담코드조회 -->
	<select id="selectChCode" resultType="CodeDomain">
		SELECT * FROM TH_CONSULT_CODE
			WHERE USE_YN = 'Y' AND LCODE = '00' AND MCODE = '00' AND SCODE = '00' ORDER BY SORT_IDX ASC
	</select>

	<!-- 상담코드조회 -->
	<select id="selectLcode" resultType="CodeDomain">
		SELECT * FROM TH_CONSULT_CODE
			WHERE USE_YN = 'Y' AND CHNL_CODE = #{chnlCode} AND LCODE != '00' AND MCODE = '00' AND SCODE = '00'
			<if test="callGbCd == 'i'.toString()">
				AND CALL_GB_CD IN ('01','03')
			</if>
			<if test="callGbCd == 'o'.toString()">
				AND CALL_GB_CD IN ('01','03')
			</if>
			<if test="callGbCd == 'c'.toString()">
				AND CALL_GB_CD IN ('02','03')
			</if>
			ORDER BY SORT_IDX ASC
	</select>

	<!-- 중분류코드조회 -->
	<select id="selectMcode" resultType="CodeDomain">
		SELECT * FROM TH_CONSULT_CODE
			WHERE USE_YN = 'Y' AND CHNL_CODE = #{chnlCode} AND LCODE = #{lcode} AND MCODE != '00' AND SCODE = '00'
			<if test="callGbCd == 'i'.toString()">
				AND CALL_GB_CD IN ('01','03')
			</if>
			<if test="callGbCd == 'o'.toString()">
				AND CALL_GB_CD IN ('01','03')
			</if>
			<if test="callGbCd == 'c'.toString()">
				AND CALL_GB_CD IN ('02','03')
			</if>
			ORDER BY SORT_IDX ASC
	</select>

	<!-- 소분류코드조회 -->
	<select id="selectScode" resultType="CodeDomain">
		SELECT * FROM TH_CONSULT_CODE
			WHERE USE_YN = 'Y' AND CHNL_CODE = #{chnlCode} AND LCODE = #{lcode} AND MCODE = #{mcode} AND SCODE != '00'
			<if test="callGbCd == 'i'.toString()">
				AND CALL_GB_CD IN ('01','03')
			</if>
			<if test="callGbCd == 'o'.toString()">
				AND CALL_GB_CD IN ('01','03')
			</if>
			<if test="callGbCd == 'c'.toString()">
				AND CALL_GB_CD IN ('02','03')
			</if>
			ORDER BY SORT_IDX ASC
	</select>

	<!-- 상담사정보조회 -->
	<select id="selectUserList" resultType="UserDomain">
		SELECT
			A.USER_ID, A.USER_NM, A.CALL_TEL_NUM
			FROM IF_CO_USER_MA A JOIN IF_CO_USER_HI B
				ON A.USER_ID = B.USER_ID
				WHERE B.DEPT_CD = 'B00604'
					AND A.IS_DELETED = 0
		            AND B.LAST_YN = 'Y'
		            AND B.RTRM_YN = 'N'
				ORDER BY A.USER_NM ASC
	</select>

	<!-- SMS전송내역 저장 -->
	<insert id="insertSms" parameterType="java.util.Map">
		INSERT INTO TH_SEND_SMS
		(
			SEND_SMS_SEQ, TELL_NUM, SMS_CONTENT, SEND_SMS_DATE, SEND_USER_ID, SMS_TITLE
		)
		VALUES
		(
			SEQ_TH_SEND_SMS.NEXTVAL, #{tellNum}, #{content}, sysdate, #{userId}, #{title, jdbcType=VARCHAR}
		)
	</insert>

	<!-- 특이성향 고객 조회 -->
	<select id="selectSpecial" parameterType="ConsultDetailDomain" resultType="InboundSpecialDomain">
			SELECT
				B.CNLT_SEQ,
				B.CNLT_DETAIL_NO,
				C.*,
				A.CUST_NM AS CS_KRN_NM,
				(SELECT USER_NM FROM IF_CO_USER_MA WHERE USER_ID = C.REG_ID) AS USER_NM
			FROM TH_CONSULT A JOIN TH_CONSULT_DETAIL B
				ON A.CNLT_SEQ = B.CNLT_SEQ
				JOIN TH_SPECIAL_CUST C
				ON (C.UNTY_CSNO = A.CUST_NO OR C.TELL_NUM = B.TELL_NUM)
				AND C.CNLT_SEQ = B.CNLT_SEQ
		        AND C.CNLT_DETAIL_NO = B.CNLT_DETAIL_NO
				WHERE
				C.UNTY_CSNO = #{untyCsno}
				OR C.TELL_NUM = #{tellNum}
				AND C.SPCL_APPV_YN = 'Y'
	</select>

	<!-- 특이성향 고객 총개수 -->
	<select id="specialTotalCnt" parameterType="ConsultDetailDomain" resultType="java.lang.Integer">
			SELECT COUNT(*) FROM
				(SELECT
					B.CNLT_SEQ,
					B.CNLT_DETAIL_NO,
					C.*,
					A.CUST_NM AS CS_KRN_NM,
					(SELECT USER_NM FROM IF_CO_USER_MA WHERE USER_ID = C.REG_ID) AS USER_NM
				FROM TH_CONSULT A JOIN TH_CONSULT_DETAIL B
					ON A.CNLT_SEQ = B.CNLT_SEQ
					JOIN TH_SPECIAL_CUST C
					ON (C.UNTY_CSNO = A.CUST_NO OR C.TELL_NUM = B.TELL_NUM)
					AND C.CNLT_SEQ = B.CNLT_SEQ
			        AND C.CNLT_DETAIL_NO = B.CNLT_DETAIL_NO
					WHERE
					C.UNTY_CSNO = #{untyCsno}
					OR C.TELL_NUM = #{tellNum}
					AND C.SPCL_APPV_YN = 'Y')
	</select>

	<!-- 조직도 조회 -->
	<select id="selectOrganization" resultType="OrganizationDomain">
		SELECT LEVEL, DEPT_CD, DEPT_NM, UPPR_DEPT FROM IF_CO_ORNG_MA
		START WITH DEPT_CD = 'B00000'
		CONNECT BY PRIOR DEPT_CD = UPPR_DEPT
	</select>

	<!-- 조직도 조회(부서) -->
	<select id="organizationSearch" resultType="OrganizationDomain" parameterType="OrganizationDomain">
		SELECT
		A.USER_ID,
		A.USER_NM,
		EMAILADR_1 AS EMAIL_ADR,
		OFRM_TEL_NO,
		B.DEPT_CD
			FROM IF_CO_USER_MA A ,IF_CO_USER_HI B
			WHERE A.USER_ID = B.USER_ID AND B.DEPT_CD = #{deptCd}
	</select>

	<!-- 조직도 조회(조직원) -->
	<select id="selectOrgn" resultType="OrganizationDomain" parameterType="java.util.Map">
		SELECT
			A.USER_ID,
			A.USER_NM,
			A.EMAILADR_1 AS EMAIL_ADR,
			A.OFRM_TEL_NO,
			B.DEPT_CD
			FROM IF_CO_USER_MA A ,IF_CO_USER_HI B
			WHERE A.USER_ID = B.USER_ID
			<if test="kbizId != null and kbizId != '' ">
			AND A.USER_ID LIKE '%' || #{kbizId} || '%'
			</if>
			<if test="kbizNm != null and kbizNm != '' ">
			AND A.USER_NM LIKE '%' || #{kbizNm} || '%'
			</if>
	</select>

	<!-- 관리자 리스트 -->
	<select id="selectAdminList" resultType="OrganizationDomain">
		SELECT A.USER_ID, A.USER_NM, A.CALL_TEL_NUM FROM
		IF_CO_USER_MA A JOIN IF_CO_USER_HI B
		ON A.USER_ID = B.USER_ID
			WHERE B.CALL_AP_GRADE = '02' AND B.DEPT_CD = 'B00604'
			<!-- OR B.CALL_AP_GRADE = '01' AND B.DEPT_CD = 'B00604' -->
	</select>

	<!-- VOC이관내역 내부 저장 -->
	<insert id="vocReg" parameterType="VocDomain">
		INSERT INTO TH_VOC
			(CST_NM, NEEDS_TYPE, RECE_USER_ID,
			CST_NO, TELNO, TIT,
			QSTN_CNTN, CONT_NO, CALL_SEQ,
			CALL_DTL_SEQ, WRK_DVN, TAKE_MAN_OPI,
			CHRG_USER_ID, CHRG_DEP_CD, CS_RNNO,
			VOC_RSTL_CODE, REG_ID, REG_DATE)
		VALUES
			(#{cstNm},#{needsType},#{receUserId},
			#{cstNo},#{telno},#{tit},
			#{qstnCntn},#{contNo},#{callSeq},
			#{callDtlSeq},#{wrkDvn},#{takeManOpi},
			#{chrgUserId},#{chrgDepCd},#{csRnno},
			#{vocRstlCode},#{regId},SYSDATE)
	</insert>

	<!-- SMS이력조회 -->
	<select id="smsList" parameterType="SmsDomain" resultType="SmsDomain">
		SELECT * FROM
		(SELECT B.*, ROWNUM AS RNUM FROM
			(SELECT
				A.SEND_SMS_SEQ, A.TELL_NUM, A.SMS_CONTENT,
				A.SEND_SMS_DATE, (SELECT USER_NM FROM IF_CO_USER_MA WHERE USER_ID = A.SEND_USER_ID) AS SEND_USER_NM
			FROM TH_SEND_SMS A
				WHERE TELL_NUM = #{tellNum}) B
		 )
		 WHERE RNUM BETWEEN #{fromRowPerPage} AND #{toRowPerPage}
	</select>

	<!-- SMS이력총개수 -->
	<select id="smsTotalCnt" parameterType="SmsDomain" resultType="java.lang.Integer">
			SELECT
				COUNT(*)
			FROM TH_SEND_SMS
				WHERE TELL_NUM = #{tellNum}
	</select>

	<!-- SMS 상세 -->
	<select id="smsDetail" parameterType="SmsDomain" resultType="SmsDomain">
		SELECT
			A.TELL_NUM,
			A.SMS_CONTENT,
			A.SMS_TITLE,
			A.SEND_SMS_DATE,
			(SELECT USER_NM FROM IF_CO_USER_MA WHERE USER_ID = A.SEND_USER_ID) AS SEND_USER_NM
		FROM TH_SEND_SMS A
		WHERE SEND_SMS_SEQ = #{sendSmsSeq}
	</select>

    <!-- 메신저 저장 -->
	<insert id="mesgSend" parameterType="MessengerDomain">
        INSERT INTO TH_MESSENGER
        (
            MESG_SEQ,
            USER_ID,
            TRAN_ID,
            MESG_CONTENT,
            MESG_TITLE,
            MESG_URL,
            REG_ID,
            REG_DATE
        )VALUES
        (
            SEQ_TH_MESSENGER.NEXTVAL,
            #{userId},
            #{tranId},
            #{mesgContent},
            #{mesgTitle},
            #{mesgUrl},
            #{loginUserId},
            SYSDATE
        )
	</insert>
</mapper>